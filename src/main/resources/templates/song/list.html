<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <link rel="icon" type="image/png" href="/img/unearth_icon.png">
    <title>UNEARTH | ìŒì› ë“±ë¡</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/song.css">
</head>
<body>
<div th:replace="~{common/header :: header}"></div>
<div class="main-container">
    <div th:replace="~{common/sidebar :: sidebar(activeMenu='songRegister')}"></div>
    <section class="content">
        <h2>ìŒì› ë“±ë¡</h2>
        
        <!-- ê¶Œë¦¬ìê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ -->
        <div th:if="${rightHolders.isEmpty()}" class="alert-message" style="background-color: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <strong>âš ï¸ ê¶Œë¦¬ì ë“±ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤</strong><br>
            ìŒì›ì„ ë“±ë¡í•˜ê¸° ìœ„í•´ì„œëŠ” ë¨¼ì € ê¶Œë¦¬ìë¥¼ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.<br>
            <a href="/right-holder/list" style="color: #0056b3; text-decoration: underline;">ê¶Œë¦¬ì ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™</a>
        </div>
        
        <form id="songRegisterForm" class="register-form" method="post" th:action="@{/song/register}" th:style="${rightHolders.isEmpty()} ? 'opacity: 0.5; pointer-events: none;' : ''">
            <div class="song-form-grid">
                <div class="form-row"><label>ì•„í‹°ìŠ¤íŠ¸ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="artistKo" required /></div>
                <div class="form-row"><label>ì•¨ë²”ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="albumKo" required /></div>
                <div class="form-row"><label>íŠ¸ë™ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="titleKo" required /></div>
                <div class="form-row"><label>songId(ë©œë¡ ) <span class="required-star">*</span></label><input type="text" name="melonSongId" required /></div>
                <div class="form-row"><label>ì•„í‹°ìŠ¤íŠ¸ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="artistEn" required /></div>
                <div class="form-row"><label>ì•¨ë²”ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="albumEn" required /></div>
                <div class="form-row"><label>íŠ¸ë™ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="titleEn" required /></div>
                <div class="form-row"><label>ìœ íŠœë¸Œ ê³µì‹ URL <span class="required-star">*</span></label><input type="text" name="youtubeUrl" required /></div>
                <div class="form-row">
                    <label>ê¶Œë¦¬ìëª… <span class="required-star">*</span></label>
                    <select name="rightHolderName" required>
                        <option value="">ê¶Œë¦¬ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option th:each="holder : ${rightHolders}" th:value="${holder}" th:text="${holder}"></option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <button type="submit" class="register-btn" id="songRegisterBtn" disabled>ìŒì› ë“±ë¡í•˜ê¸°</button>
            </div>
        </form>
        <form class="search-form" method="get" th:action="@{/song/list}">
            <div class="search-row">
                <div class="search-group"><label>ê²€ìƒ‰</label><input type="text" name="search" class="search-input" th:value="${search}" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" /></div>
                <div class="search-group search-btn-group"><button type="submit" class="search-btn">ê²€ìƒ‰</button></div>
            </div>
        </form>
        <table class="holder-table song-table">
            <thead>
            <tr>
                <th>ì•„í‹°ìŠ¤íŠ¸ëª…(êµ­ë¬¸)</th><th>ì•¨ë²”ëª…(êµ­ë¬¸)</th><th>íŠ¸ë™ëª…(êµ­ë¬¸)</th><th>ìœ íŠœë¸Œ ê³µì‹ URL</th><th>ê¶Œë¦¬ìëª…</th><th>í¬ë¡¤ë§ ì‹¤í–‰</th><th>ìˆ˜ì •</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="song : ${response.data.content}">
                <td th:text="${song.artistKo}"></td>
                <td th:text="${song.albumKo}"></td>
                <td th:text="${song.titleKo}"></td>
                <td><a th:href="${song.youtubeUrl}" target="_blank" class="ellipsis" th:text="${song.youtubeUrl}"></a></td>
                <td th:text="${song.rightHolder.holderName}"></td>
                <td class="crawling-column">
                    <button type="button" class="crawling-btn" 
                            th:data-song-id="${song.id}" 
                            th:data-artist-ko="${song.artistKo}" 
                            th:data-title-ko="${song.titleKo}" 
                            th:data-has-crawling="${song.crawlingStartDate != null}">ğŸ•¹ï¸</button>
                    
                    <span class="crawling-period" th:if="${song.crawlingStartDate != null and song.crawlingEndDate != null}" 
                          th:text="${#temporals.format(song.crawlingStartDate, 'yy.MM.dd')} + ' ~ ' + ${#temporals.format(song.crawlingEndDate, 'yy.MM.dd')}"></span>
                    <span class="crawling-period empty" th:if="${song.crawlingStartDate == null or song.crawlingEndDate == null}">-</span>
                </td>
                <td class="edit-column">
                    <button type="button" class="edit-btn"
                            th:data-song-id="${song.id}"
                            th:data-artist-ko="${song.artistKo}"
                            th:data-artist-en="${song.artistEn}"
                            th:data-album-ko="${song.albumKo}"
                            th:data-album-en="${song.albumEn}"
                            th:data-title-ko="${song.titleKo}"
                            th:data-title-en="${song.titleEn}"
                            th:data-youtube-url="${song.youtubeUrl}"
                            th:data-melon-song-id="${song.melonSongId}"
                            th:data-right-holder-name="${song.rightHolder.holderName}"
                            onclick="openEditModalFromData(this)">ìˆ˜ì •
                    </button>
                </td>
            </tr>
            <tr th:if="${response.data.content.size() == 0}"><td colspan="7" style="text-align:center;">ìŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            </tbody>
        </table>
        <div class="pagination" th:if="${response.data.totalPages > 0}">
            <a th:if="${response.data.hasPrevious()}" th:href="@{/song/list(page=${response.data.number - 1}, size=${size}, search=${search})}" class="page-btn">ì´ì „</a>
            <span th:each="i : ${#numbers.sequence(0, response.data.totalPages - 1)}">
                <a th:if="${i != response.data.number}" th:href="@{/song/list(page=${i}, size=${size}, search=${search})}" th:text="${i + 1}" class="page-btn"></a>
                <span th:if="${i == response.data.number}" th:text="${i + 1}" class="page-btn current"></span>
            </span>
            <a th:if="${response.data.hasNext()}" th:href="@{/song/list(page=${response.data.number + 1}, size=${size}, search=${search})}" class="page-btn">ë‹¤ìŒ</a>
        </div>
    </section>
</div>

<!-- ìŒì› ìˆ˜ì • ëª¨ë‹¬ -->
<div id="editModal" class="modal">
    <div class="modal-content song-edit-modal-content">
        <button type="button" id="closeEditModalBtn" class="close-btn">&times;</button>
        <h3>ìŒì› ìˆ˜ì •</h3>
        <form id="editForm" class="modal-form" method="post">
            <div class="song-edit-form-grid">
                <div class="form-row"><label>ì•„í‹°ìŠ¤íŠ¸ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="artistKo" required /></div>
                <div class="form-row"><label>ì•¨ë²”ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="albumKo" required /></div>
                <div class="form-row"><label>íŠ¸ë™ëª…(êµ­ë¬¸) <span class="required-star">*</span></label><input type="text" name="titleKo" required /></div>
                <div class="form-row"><label>songId(ë©œë¡ ) <span class="required-star">*</span></label><input type="text" name="melonSongId" required /></div>
                <div class="form-row"><label>ì•„í‹°ìŠ¤íŠ¸ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="artistEn" required /></div>
                <div class="form-row"><label>ì•¨ë²”ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="albumEn" required /></div>
                <div class="form-row"><label>íŠ¸ë™ëª…(ì˜ë¬¸) <span class="required-star">*</span></label><input type="text" name="titleEn" required /></div>
                <div class="form-row"><label>ìœ íŠœë¸Œ ê³µì‹ URL <span class="required-star">*</span></label><input type="text" name="youtubeUrl" required /></div>
                <div class="form-row">
                    <label>ê¶Œë¦¬ìëª… <span class="required-star">*</span></label>
                    <select name="rightHolderName" required>
                        <option value="">ê¶Œë¦¬ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option th:each="holder : ${rightHolders}" th:value="${holder}" th:text="${holder}"></option>
                    </select>
                </div>
            </div>
            <div class="form-row" style="margin-top:18px;">
                <button type="submit" class="register-btn" style="width:100%;">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- í¬ë¡¤ë§ ì‹¤í–‰ ëª¨ë‹¬ -->
<div id="crawlingModal" class="modal">
    <div class="modal-content crawling-modal-content">
        <button type="button" id="closeCrawlingModalBtn" style="position:absolute; right:18px; top:18px; background:none; border:none; font-size:22px; cursor:pointer;">&times;</button>
        <h3 id="crawlingModalTitle" style="margin-bottom:18px;">í¬ë¡¤ë§ ì‹¤í–‰</h3>
        <form id="crawlingForm" method="post" action="/crawling/execute">
            <input type="hidden" id="crawlingSongId" name="songId" />
            <div class="form-row">
                <label>ì±„ë„ëª… <span class="required-star">*</span></label>
                <input type="text" name="channel" required />
            </div>
            <div class="form-row">
                <label>ìœ íŠœë¸Œ ì˜ìƒ ì œëª© <span class="required-star">*</span></label>
                <input type="text" name="youtubeTitle" required />
            </div>
            <div class="form-row">
                <label>ìœ íŠœë¸Œ ì˜ìƒ URL <span class="required-star">*</span></label>
                <input type="text" name="youtubeUrl" required />
            </div>
            <div class="form-row">
                <label>ìˆ˜ë¡ ìˆœì„œ <span class="required-star">*</span></label>
                <input type="number" name="songOrder" min="1" required />
            </div>
            <div class="form-row" style="margin-top:18px;">
                <button type="submit" class="crawling-execute-btn" style="width:100%;">í¬ë¡¤ë§ ì‹¤í–‰</button>
            </div>
        </form>
    </div>
</div>
<script>
// í¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ë²„íŠ¼ í™œì„±í™”
const form = document.getElementById('songRegisterForm');
const btn = document.getElementById('songRegisterBtn');

// ê¶Œë¦¬ìê°€ ì—†ëŠ” ê²½ìš° í¼ ë¹„í™œì„±í™”
const rightHoldersEmpty = /*[[${rightHolders.isEmpty()}]]*/ false;
if (rightHoldersEmpty) {
    btn.disabled = true;
    btn.textContent = 'ê¶Œë¦¬ì ë“±ë¡ í›„ ì´ìš© ê°€ëŠ¥';
}

function validateForm() {
    // ê¶Œë¦¬ìê°€ ì—†ìœ¼ë©´ ê²€ì¦í•˜ì§€ ì•ŠìŒ
    if (rightHoldersEmpty) {
        btn.disabled = true;
        return;
    }
    
    let valid = true;
    ['artistKo','artistEn','albumKo','albumEn','titleKo','titleEn','youtubeUrl','melonSongId','rightHolderName'].forEach(name => {
        const el = form.elements[name];
        if (!el || !el.value || el.value.trim() === '') valid = false;
    });
    btn.disabled = !valid;
}

// ê¶Œë¦¬ìê°€ ìˆì„ ë•Œë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
if (!rightHoldersEmpty) {
    form && form.addEventListener('input', validateForm);
    form && form.addEventListener('change', validateForm);
    form && form.addEventListener('submit', function(e) {
        if (btn.disabled) { e.preventDefault(); return false; }
        if (!confirm('ìŒì›ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { e.preventDefault(); return false; }
    });
}

// í¬ë¡¤ë§ ì‹¤í–‰ ëª¨ë‹¬ ì œì–´
const crawlingModal = document.getElementById('crawlingModal');
const closeCrawlingModalBtn = document.getElementById('closeCrawlingModalBtn');
const crawlingForm = document.getElementById('crawlingForm');
const crawlingModalTitle = document.getElementById('crawlingModalTitle');
const crawlingSongId = document.getElementById('crawlingSongId');

// í¬ë¡¤ë§ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
    const crawlingBtns = document.querySelectorAll('.crawling-btn');
    crawlingBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const songId = this.dataset.songId;
            const artistKo = this.dataset.artistKo;
            const titleKo = this.dataset.titleKo;
            const hasCrawlingHistory = this.dataset.hasCrawling === 'true';
            
            handleCrawlingClick(songId, artistKo, titleKo, hasCrawlingHistory);
        });
    });
});

function handleCrawlingClick(songId, artistKo, titleKo, hasCrawlingHistory) {
    if (hasCrawlingHistory) {
        // ì´ë¯¸ í¬ë¡¤ë§ ê¸°ë¡ì´ ìˆëŠ” ê²½ìš° ë¨¼ì € í™•ì¸ íŒì—…
        if (!confirm('í¬ë¡¤ë§ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return; // ì·¨ì†Œí•˜ë©´ ëª¨ë‹¬ ì—´ì§€ ì•ŠìŒ
        }
    }
    // í™•ì¸í–ˆê±°ë‚˜ ì²˜ìŒ í¬ë¡¤ë§ì¸ ê²½ìš° ëª¨ë‹¬ ì—´ê¸°
    openCrawlingModal(songId, artistKo, titleKo);
}

function openCrawlingModal(songId, artistKo, titleKo) {
    crawlingModalTitle.textContent = artistKo + ' - ' + titleKo;
    crawlingSongId.value = songId;
    crawlingModal.classList.add('show');
}

closeCrawlingModalBtn && closeCrawlingModalBtn.addEventListener('click', () => {
    crawlingModal.classList.remove('show');
});

window.addEventListener('click', (e) => {
    if (e.target === crawlingModal) {
        crawlingModal.classList.remove('show');
    }
});

// í¬ë¡¤ë§ í¼ ì œì¶œ
crawlingForm && crawlingForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(crawlingForm);
    
    fetch('/crawling/execute', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 'SUCCESS') {
            alert('í¬ë¡¤ë§ì´ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
            crawlingModal.classList.remove('show');
            location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ í¬ë¡¤ë§ ê¸°ê°„ ì—…ë°ì´íŠ¸
        } else {
            alert('í¬ë¡¤ë§ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('í¬ë¡¤ë§ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});

// ìŒì› ìˆ˜ì • ëª¨ë‹¬ ì œì–´
const editModal = document.getElementById('editModal');
const closeEditModalBtn = document.getElementById('closeEditModalBtn');
const editForm = document.getElementById('editForm');

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
closeEditModalBtn && closeEditModalBtn.addEventListener('click', () => {
    editModal.classList.remove('show');
});

window.addEventListener('click', (e) => {
    if (e.target === editModal) {
        editModal.classList.remove('show');
    }
});

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (data-* ì†ì„±ì—ì„œ ë°ì´í„° ì½ê¸°)
function openEditModalFromData(button) {
    const songId = button.getAttribute('data-song-id');
    const artistKo = button.getAttribute('data-artist-ko');
    const artistEn = button.getAttribute('data-artist-en');
    const albumKo = button.getAttribute('data-album-ko');
    const albumEn = button.getAttribute('data-album-en');
    const titleKo = button.getAttribute('data-title-ko');
    const titleEn = button.getAttribute('data-title-en');
    const youtubeUrl = button.getAttribute('data-youtube-url');
    const melonSongId = button.getAttribute('data-melon-song-id');
    const rightHolderName = button.getAttribute('data-right-holder-name');
    
    const form = document.getElementById('editForm');
    form.action = `/song/${songId}/update`;
    
    form.elements['artistKo'].value = artistKo;
    form.elements['artistEn'].value = artistEn;
    form.elements['albumKo'].value = albumKo;
    form.elements['albumEn'].value = albumEn;
    form.elements['titleKo'].value = titleKo;
    form.elements['titleEn'].value = titleEn;
    form.elements['youtubeUrl'].value = youtubeUrl;
    form.elements['melonSongId'].value = melonSongId;
    form.elements['rightHolderName'].value = rightHolderName;
    
    editModal.classList.add('show');
}

// ìˆ˜ì • í¼ ìœ íš¨ì„± ë° ìˆ˜ì • ì „ í™•ì¸
if (editForm) {
    editForm.addEventListener('submit', function(e) {
        // í•„ìˆ˜ê°’ ì²´í¬
        const required = ['artistKo','artistEn','albumKo','albumEn','titleKo','titleEn','youtubeUrl','melonSongId','rightHolderName'];
        for (const name of required) {
            const el = editForm.elements[name];
            if (!el || !el.value || el.value.trim() === '') {
                alert(el.previousElementSibling ? el.previousElementSibling.innerText.replace('*','').trim() + 'ì€(ëŠ”) í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.' : 'í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.');
                el && el.focus();
                e.preventDefault();
                return false;
            }
        }
        // ìˆ˜ì • í™•ì¸
        if (!confirm('ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            e.preventDefault();
            return false;
        }
        // ìˆ˜ì • ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨ì€ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ redirectë¡œ ì²˜ë¦¬ë¨
    });
}
</script>
</body>
</html> 