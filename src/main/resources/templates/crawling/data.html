<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UNEARTH | í¬ë¡¤ë§ ë°ì´í„°</title>
    <link rel="icon" type="image/png" href="/img/unearth_icon.png">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/right_holder.css">
</head>
<body>
<div th:replace="~{common/header :: header}"></div>
<div class="main-container">
    <section class="content">
        <div class="page-header">
            <h2 th:text="${crawlingData.songInfo.artistKo} + ' - ' + ${crawlingData.songInfo.titleKo}">í¬ë¡¤ë§ ë°ì´í„°</h2>
            <a th:href="@{'/right-holder/' + ${crawlingData.songInfo.rightHolder.id}}" class="back-btn">â† ë…¸ë˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <!-- í•„í„°ë§ í¼ -->
        <form class="filter-form" method="get" th:action="@{'/crawling/data/' + ${songId}}">
            <div class="filter-row">
                <div class="filter-group">
                    <label>ì‹œì‘ì¼</label>
                    <label>
                        <input type="date" name="startDate" class="filter-input" th:value="${startDate}" />
                    </label>
                </div>
                <div class="filter-group">
                    <label>ì¢…ë£Œì¼</label>
                    <label>
                        <input type="date" name="endDate" class="filter-input" th:value="${endDate}" />
                    </label>
                </div>
                <div class="filter-group">
                    <label>í”Œë«í¼</label>
                    <label>
                        <select name="platform" class="filter-input">
                            <option value="">ì „ì²´</option>
                            <option value="MELON" th:selected="${platform == 'MELON'}">ë©œë¡ </option>
                            <option value="YOUTUBE_MUSIC" th:selected="${platform == 'YOUTUBE_MUSIC'}">ìœ íŠœë¸Œ ë®¤ì§</option>
                            <option value="YOUTUBE" th:selected="${platform == 'YOUTUBE'}">ìœ íŠœë¸Œ</option>
                            <option value="GENIE" th:selected="${platform == 'GENIE'}">ì§€ë‹ˆ</option>
                        </select>
                    </label>
                </div>

                <div class="filter-group">
                    <label>í˜ì´ì§€ í¬ê¸°</label>
                    <label>
                        <select name="size" class="filter-input">
                            <option value="10" th:selected="${crawlingData.pageInfo.pageSize == 10}">10ê°œ</option>
                            <option value="20" th:selected="${crawlingData.pageInfo.pageSize == 20}">20ê°œ</option>
                            <option value="50" th:selected="${crawlingData.pageInfo.pageSize == 50}">50ê°œ</option>
                            <option value="100" th:selected="${crawlingData.pageInfo.pageSize == 100}">100ê°œ</option>
                        </select>
                    </label>
                </div>
                <div class="filter-group filter-btn-group">
                    <button type="submit" class="filter-btn">ì¡°íšŒ</button>
                    </div>
                <div class="filter-group">
                    <button type="button" class="filter-btn" style="background-color: #28a745; margin-left: 10px;" 
                            onclick="openCsvDownloadModal()">ğŸ“Š CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
        </form>

        <!-- ì•ˆë‚´ë¬¸êµ¬ ì˜ì—­ ì œê±° ë° íŒì—… ì²˜ë¦¬ -->
        <div th:if="${response.code.name() != 'SUCCESS' and response.message != null and !#strings.isEmpty(response.message)}">
            <script th:inline="javascript">
                alert(/*[[${response.message}]]*/ 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            </script>
        </div>

        <div th:if="${crawlingData.groupedDataList.size() == 0}" class="no-data-message">
            <p>í¬ë¡¤ë§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>

        <!-- í¬ë¡¤ë§ ë°ì´í„° í…Œì´ë¸” -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>í”Œë«í¼</th>
                        <th>ì¡°íšŒìˆ˜</th>
                        <th>ì¡°íšŒìˆ˜ ì¦ê°€</th>
                        <th>ì²­ì·¨ì ìˆ˜</th>
                        <th>ì²­ì·¨ì ìˆ˜ ì¦ê°€</th>
                        <th>ì˜ìƒ ì •ë³´</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”ëœ ë°ì´í„° í‘œì‹œ -->
                    <th:block th:each="groupedData, groupIter : ${crawlingData.groupedDataList}">
                        <tr th:each="data, dataIter : ${groupedData.dataList}" 
                            th:class="${groupIter.index > 0 && dataIter.first ? 'date-separator' : ''}">
                            
                            <!-- ë‚ ì§œ ì…€ (í•´ë‹¹ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ í‘œì‹œ, rowspan ì ìš©) -->
                            <td th:if="${dataIter.first}" 
                                th:rowspan="${groupedData.dataListSize}"
                                th:text="${#temporals.format(groupedData.date, 'yyyy-MM-dd')}" 
                                class="date-cell">
                            </td>
                            
                            <!-- í”Œë«í¼ ì •ë³´ -->
                            <td th:text="${data.platform}" class="platform-cell"></td>
                            
                            <!-- ì¡°íšŒìˆ˜ -->
                            <td class="views-cell" 
                                th:text="${data.views == -1 ? '' : (data.views == -999 ? 'Fail' : #numbers.formatInteger(data.views, 0, 'COMMA'))}"
                                th:class="${data.views == -1 ? 'text-muted' : (data.views == -999 ? 'text-warning' : '')}">
                            </td>
                            
                            <!-- ì¡°íšŒìˆ˜ ì¦ê°€ -->
                            <td class="views-increase-cell"
                                th:text="${data.viewsIncrease == -1 ? '' : (data.viewsIncrease == -999 ? 'Fail' : (data.viewsIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.viewsIncrease, 0, 'COMMA'))}"
                                th:class="${data.viewsIncrease == -1 ? 'text-muted' : (data.viewsIncrease == -999 ? 'text-warning' : (data.viewsIncrease > 0 ? 'text-success' : (data.viewsIncrease < 0 ? 'text-danger' : 'text-muted')))}">
                            </td>
                            
                            <!-- ì²­ì·¨ì ìˆ˜ -->
                            <td class="listeners-cell"
                                th:text="${data.listeners == -1 ? '' : (data.listeners == -999 ? 'Fail' : #numbers.formatInteger(data.listeners, 0, 'COMMA'))}"
                                th:class="${data.listeners == -1 ? 'text-muted' : (data.listeners == -999 ? 'text-warning' : '')}">
                            </td>
                            
                            <!-- ì²­ì·¨ì ìˆ˜ ì¦ê°€ -->
                            <td class="listeners-increase-cell"
                                th:text="${data.listenersIncrease == -1 ? '' : (data.listenersIncrease == -999 ? 'Fail' : (data.listenersIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.listenersIncrease, 0, 'COMMA'))}"
                                th:class="${data.listenersIncrease == -1 ? 'text-muted' : (data.listenersIncrease == -999 ? 'text-warning' : (data.listenersIncrease > 0 ? 'text-success' : (data.listenersIncrease < 0 ? 'text-danger' : 'text-muted')))}">
                            </td>
                            
                            <!-- ì˜ìƒ ì •ë³´ ì…€ (í•´ë‹¹ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ í‘œì‹œ, rowspan ì ìš©) -->
                            <td th:if="${dataIter.first}" 
                                th:rowspan="${groupedData.dataListSize}"
                                class="video-info-cell">
                                <div th:if="${groupedData.hasVideoInfo()}">
                                    <div th:each="videoInfo : ${groupedData.videoInfos}" class="video-info-item">
                                        <div class="video-info-row">
                                            <span class="video-label">ì±„ë„ëª…:</span>
                                            <span class="video-value" th:text="${videoInfo.channel}"></span>
                                        </div>
                                        <div class="video-info-row">
                                            <span class="video-label">ì œëª©:</span>
                                            <span class="video-value">
                                                <a th:href="${videoInfo.youtubeUrl}" target="_blank" 
                                                   th:text="${videoInfo.youtubeTitle}"></a>
                                            </span>
                                        </div>
                                        <div class="video-info-row">
                                            <span class="video-label">ìˆ˜ë¡ ìˆœì„œ:</span>
                                            <span class="video-value" th:text="${videoInfo.songOrder}"></span>
                                        </div>
                                        <div class="video-info-row" th:if="${videoInfo.uploadAt != null}">
                                            <span class="video-label">ì—…ë¡œë“œ ë‚ ì§œ:</span>
                                            <span class="video-value" th:text="${#temporals.format(videoInfo.uploadAt, 'yyyy-MM-dd HH:mm')}"></span>
                                        </div>
                                    </div>
                                </div>
                                <div th:unless="${groupedData.hasVideoInfo()}" class="no-video-info">-</div>
                            </td>
                        </tr>
                    </th:block>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ (pageInfoë¡œ ì ‘ê·¼ ë°©ì‹ ë³€ê²½) -->
        <div class="pagination" th:if="${crawlingData.pageInfo.totalPages > 0}">
            <a th:if="${crawlingData.pageInfo.currentPage > 1}" 
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${crawlingData.pageInfo.currentPage - 1}, size=${crawlingData.pageInfo.pageSize})}" 
               class="page-btn">ì´ì „</a>
            <span th:each="pageNum : ${#numbers.sequence(1, crawlingData.pageInfo.totalPages)}">
                <a th:if="${pageNum != crawlingData.pageInfo.currentPage}" 
                   th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${pageNum}, size=${crawlingData.pageInfo.pageSize})}" 
                   th:text="${pageNum}" 
                   class="page-btn"></a>
                <span th:if="${pageNum == crawlingData.pageInfo.currentPage}" 
                      th:text="${pageNum}" 
                      class="page-btn current"></span>
            </span>
            <a th:if="${crawlingData.pageInfo.currentPage < crawlingData.pageInfo.totalPages}" 
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${crawlingData.pageInfo.currentPage + 1}, size=${crawlingData.pageInfo.pageSize})}" 
               class="page-btn">ë‹¤ìŒ</a>
        </div>
    </section>
</div>

<!-- CSV ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
<div id="csvDownloadModal" class="modal" style="display: none;" th:data-song-id="${songId}">
    <div class="modal-content csv-modal-content">
        <div class="csv-modal-header">
            <h3>CSV ë‹¤ìš´ë¡œë“œ ì„¤ì •</h3>
            <span class="modal-close" onclick="closeCsvDownloadModal()">&times;</span>
        </div>
        <div class="csv-modal-body">
            <form id="csvDownloadForm">
                <div class="csv-form-group">
                    <label>ì‹œì‘ì¼</label>
                    <label for="csvStartDate"></label><input type="date" id="csvStartDate" class="csv-form-input" th:value="${startDate}" />
                    <small>ë¹ˆê°’ìœ¼ë¡œ ë‘ë©´ ì „ì²´ ê¸°ê°„ë¶€í„° ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤</small>
                </div>
                <div class="csv-form-group">
                    <label>ì¢…ë£Œì¼</label>
                    <label for="csvEndDate"></label><input type="date" id="csvEndDate" class="csv-form-input" th:value="${endDate}" />
                    <small>ë¹ˆê°’ìœ¼ë¡œ ë‘ë©´ ì „ì²´ ê¸°ê°„ê¹Œì§€ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤</small>
                </div>
            </form>
        </div>
        <div class="csv-modal-footer">
            <button type="button" class="csv-btn csv-btn-secondary" onclick="closeCsvDownloadModal()">ì·¨ì†Œ</button>
            <button type="button" class="csv-btn csv-btn-primary" onclick="downloadCsv()">ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>
</div>

<script>
function openCsvDownloadModal() {
    // í˜„ì¬ í•„í„° ê°’ìœ¼ë¡œ ëª¨ë‹¬ ì´ˆê¸°í™”
    document.getElementById('csvStartDate').value = document.querySelector('input[name="startDate"]').value || '';
    document.getElementById('csvEndDate').value = document.querySelector('input[name="endDate"]').value || '';
    
    document.getElementById('csvDownloadModal').style.display = 'block';
}

function closeCsvDownloadModal() {
    document.getElementById('csvDownloadModal').style.display = 'none';
}

function downloadCsv() {
    const startDate = document.getElementById('csvStartDate').value;
    const endDate = document.getElementById('csvEndDate').value;
    
    // ëª¨ë‹¬ì—ì„œ songId ê°€ì ¸ì˜¤ê¸°
    const modal = document.getElementById('csvDownloadModal');
    const songId = modal.getAttribute('data-song-id');
    
    if (!songId) {
        alert('ìŒì› IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // URL ìƒì„±
    let url = `/crawling/data/${songId}/csv`;
    const params = new URLSearchParams();
    
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }

    // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
    window.location.href = url;
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeCsvDownloadModal();
}
</script>

</body>
</html> 