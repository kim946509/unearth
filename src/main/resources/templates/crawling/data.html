<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UNEARTH | í¬ë¡¤ë§ ë°ì´í„°</title>
    <link rel="icon" type="image/png" href="/img/unearth_icon.png">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/right_holder.css">
</head>
<body>
<div th:replace="~{common/header :: header}"></div>
<div class="main-container">
    <div th:replace="~{common/sidebar :: sidebar(activeMenu='rightHolderList')}"></div>
    <section class="content">
        <div class="page-header">
            <h2 th:text="${crawlingData.songInfo.artistKo} + ' - ' + ${crawlingData.songInfo.titleKo}">í¬ë¡¤ë§ ë°ì´í„°</h2>
            <a th:href="@{'/right-holder/' + ${crawlingData.songInfo.rightHolder.id}}" class="btn btn-secondary btn-sm back-btn">â† ë…¸ë˜ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <!-- í•„í„°ë§ í¼ -->
        <div class="search-section">
            <form class="search-form" method="get" th:action="@{'/crawling/data/' + ${songId}}">
                <div class="search-row">
                    <div class="search-group">
                        <label class="form-label">ì‹œì‘ì¼</label>
                        <input type="date" name="startDate" class="form-control" th:value="${startDate}" />
                    </div>
                    <div class="search-group">
                        <label class="form-label">ì¢…ë£Œì¼</label>
                        <input type="date" name="endDate" class="form-control" th:value="${endDate}" />
                    </div>
                    <div class="search-group">
                        <label class="form-label">í”Œë«í¼</label>
                        <select name="platform" class="form-control">
                            <option value="">ì „ì²´</option>
                            <option value="MELON" th:selected="${platform == 'MELON'}">ë©œë¡ </option>
                            <option value="YOUTUBE_MUSIC" th:selected="${platform == 'YOUTUBE_MUSIC'}">ìœ íŠœë¸Œ ë®¤ì§</option>
                            <option value="YOUTUBE" th:selected="${platform == 'YOUTUBE'}">ìœ íŠœë¸Œ</option>
                            <option value="GENIE" th:selected="${platform == 'GENIE'}">ì§€ë‹ˆ</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label class="form-label">í˜ì´ì§€ í‘œì‹œ ì¼ìˆ˜</label>
                        <select name="days" class="form-control">
                            <option value="5" th:selected="${days == 5}">5ì¼</option>
                            <option value="7" th:selected="${days == 7}">7ì¼</option>
                            <option value="14" th:selected="${days == 14}">14ì¼</option>
                            <option value="30" th:selected="${days == 30}">30ì¼</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <button type="submit" class="btn btn-primary btn-lg">ì¡°íšŒ</button>
                    </div>
                    <div class="search-group">
                        <button type="button" class="btn btn-success btn-lg" onclick="openCsvDownloadModal()">ğŸ“Š CSV ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬ -->
        <div th:if="${response.code.name() != 'SUCCESS' and response.message != null and !#strings.isEmpty(response.message)}">
            <script th:inline="javascript">
                alert(/*[[${response.message}]]*/ 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            </script>
        </div>

        <!-- í¬ë¡¤ë§ ë°ì´í„° í…Œì´ë¸” -->
        <div class="table-section">
            <div class="table-container">
                <table class="holder-table data-table">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>í”Œë«í¼</th>
                            <th>ì¡°íšŒìˆ˜</th>
                            <th>ì¡°íšŒìˆ˜ ì¦ê°€</th>
                            <th>ì²­ì·¨ì ìˆ˜</th>
                            <th>ì²­ì·¨ì ìˆ˜ ì¦ê°€</th>
                            <th>ì˜ìƒ ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™”ëœ ë°ì´í„° í‘œì‹œ -->
                        <th:block th:each="groupedData, groupIter : ${crawlingData.groupedDataList}">
                            <tr th:each="data, dataIter : ${groupedData.dataList}" 
                                th:class="${groupIter.index > 0 && dataIter.first ? 'date-separator' : ''}">
                                
                                <!-- ë‚ ì§œ ì…€ (í•´ë‹¹ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ í‘œì‹œ, rowspan ì ìš©) -->
                                <td th:if="${dataIter.first}" 
                                    th:rowspan="${groupedData.dataListSize}"
                                    th:text="${#temporals.format(groupedData.date, 'yyyy-MM-dd')}" 
                                    class="date-cell">
                                </td>
                                
                                <!-- í”Œë«í¼ ì •ë³´ -->
                                <td th:text="${data.platform}" class="platform-cell"></td>
                                
                                <!-- ì¡°íšŒìˆ˜ -->
                                <td class="views-cell" 
                                    th:text="${data.views == -1 ? '' : (data.views == -999 ? 'Fail' : #numbers.formatInteger(data.views, 0, 'COMMA'))}"
                                    th:class="${data.views == -1 ? 'text-muted' : (data.views == -999 ? 'text-warning' : '')}">
                                </td>
                                
                                <!-- ì¡°íšŒìˆ˜ ì¦ê°€ -->
                                <td class="views-increase-cell"
                                    th:text="${data.viewsIncrease == -1 ? '' : (data.viewsIncrease == -999 ? 'Fail' : (data.viewsIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.viewsIncrease, 0, 'COMMA'))}"
                                    th:class="${data.viewsIncrease == -1 ? 'text-muted' : (data.viewsIncrease == -999 ? 'text-warning' : (data.viewsIncrease > 0 ? 'text-success' : (data.viewsIncrease < 0 ? 'text-danger' : 'text-muted')))}">
                                </td>
                                
                                <!-- ì²­ì·¨ì ìˆ˜ -->
                                <td class="listeners-cell"
                                    th:text="${data.listeners == -1 ? '' : (data.listeners == -999 ? 'Fail' : #numbers.formatInteger(data.listeners, 0, 'COMMA'))}"
                                    th:class="${data.listeners == -1 ? 'text-muted' : (data.listeners == -999 ? 'text-warning' : '')}">
                                </td>
                                
                                <!-- ì²­ì·¨ì ìˆ˜ ì¦ê°€ -->
                                <td class="listeners-increase-cell"
                                    th:text="${data.listenersIncrease == -1 ? '' : (data.listenersIncrease == -999 ? 'Fail' : (data.listenersIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.listenersIncrease, 0, 'COMMA'))}"
                                    th:class="${data.listenersIncrease == -1 ? 'text-muted' : (data.listenersIncrease == -999 ? 'text-warning' : (data.listenersIncrease > 0 ? 'text-success' : (data.listenersIncrease < 0 ? 'text-danger' : 'text-muted')))}">
                                </td>
                                
                                <!-- ì˜ìƒ ì •ë³´ ì…€ (í•´ë‹¹ ë‚ ì§œì˜ ì²« ë²ˆì§¸ í–‰ì—ì„œë§Œ í‘œì‹œ, rowspan ì ìš©) -->
                                <td th:if="${dataIter.first}" 
                                    th:rowspan="${groupedData.dataListSize}"
                                    class="video-info-cell">
                                    <div th:if="${groupedData.hasVideoInfo()}">
                                        <div th:each="videoInfo : ${groupedData.videoInfos}" class="video-info-item">
                                            <div class="video-info-row">
                                                <span class="video-label">ì±„ë„ëª…:</span>
                                                <span class="video-value" th:text="${videoInfo.channel}"></span>
                                            </div>
                                            <div class="video-info-row">
                                                <span class="video-label">ì œëª©:</span>
                                                <span class="video-value">
                                                    <a th:href="${videoInfo.youtubeUrl}" target="_blank" 
                                                       th:text="${videoInfo.youtubeTitle}"></a>
                                                </span>
                                            </div>
                                            <div class="video-info-row">
                                                <span class="video-label">ìˆ˜ë¡ ìˆœì„œ:</span>
                                                <span class="video-value" th:text="${videoInfo.songOrder}"></span>
                                            </div>
                                            <div class="video-info-row" th:if="${videoInfo.uploadAt != null}">
                                                <span class="video-label">ì—…ë¡œë“œ ë‚ ì§œ:</span>
                                                <span class="video-value" th:text="${#temporals.format(videoInfo.uploadAt, 'yyyy-MM-dd HH:mm')}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div th:unless="${groupedData.hasVideoInfo()}" class="no-video-info">-</div>
                                </td>
                            </tr>
                        </th:block>
                        <tr th:if="${crawlingData.groupedDataList.size() == 0}">
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ğŸ“Š</div>
                                <div class="empty-state-title">í¬ë¡¤ë§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                <div class="empty-state-message">ì„ íƒí•œ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" th:if="${crawlingData.pageInfo.totalPages > 0}">
            <!-- ì²« í˜ì´ì§€ -->
            <a th:if="${crawlingData.pageInfo.currentPage > 1}"
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=1, days=${days})}"
               class="page-link" title="ì²˜ìŒ">
               <img src="/img/first-arrow.png" alt="ì²˜ìŒ" style="width: 16px; height: 16px;"/>
            </a>
            <!-- ì´ì „ í˜ì´ì§€ -->
            <a th:if="${crawlingData.pageInfo.currentPage > 1}"
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${crawlingData.pageInfo.currentPage - 1}, days=${days})}"
               class="page-link" title="ì´ì „">
               <img src="/img/previous-arrow.png" alt="ì´ì „" style="width: 16px; height: 16px;"/>
            </a>
            <!-- í˜ì´ì§€ ë²ˆí˜¸ë“¤ (í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ ì•ë’¤ 5ê°œì”©, ìµœëŒ€ 10ê°œ) -->
            <th:block th:with="
                currentPage=${crawlingData.pageInfo.currentPage},
                totalPages=${crawlingData.pageInfo.totalPages},
                startPage=${T(java.lang.Math).max(1, currentPage - 4)},
                endPage=${T(java.lang.Math).min(totalPages, currentPage + 5)},
                adjustedStartPage=${T(java.lang.Math).max(1, T(java.lang.Math).min(startPage, endPage - 9))},
                adjustedEndPage=${T(java.lang.Math).min(totalPages, T(java.lang.Math).max(endPage, adjustedStartPage + 9))}
            ">
                <span th:each="i : ${#numbers.sequence(adjustedStartPage, adjustedEndPage)}">
                    <a th:if="${i != currentPage}"
                       th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${i}, days=${days})}"
                       th:text="${i}"
                       class="page-link"></a>
                    <span th:if="${i == currentPage}"
                          th:text="${i}"
                          class="page-link active"></span>
                </span>
            </th:block>
            <!-- ë‹¤ìŒ í˜ì´ì§€ -->
            <a th:if="${crawlingData.pageInfo.currentPage < crawlingData.pageInfo.totalPages}"
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${crawlingData.pageInfo.currentPage + 1}, days=${days})}"
               class="page-link" title="ë‹¤ìŒ">
               <img src="/img/next-arrow.png" alt="ë‹¤ìŒ" style="width: 16px; height: 16px;"/>
            </a>
            <!-- ë§ˆì§€ë§‰ í˜ì´ì§€ -->
            <a th:if="${crawlingData.pageInfo.currentPage < crawlingData.pageInfo.totalPages}"
               th:href="@{/crawling/data/{songId}(songId=${songId}, startDate=${startDate}, endDate=${endDate}, platform=${platform}, page=${crawlingData.pageInfo.totalPages}, days=${days})}"
               class="page-link" title="ë§ˆì§€ë§‰">
               <img src="/img/last-arrow.png" alt="ë§ˆì§€ë§‰" style="width: 16px; height: 16px;"/>
            </a>
        </div>
    </section>
</div>

<!-- CSV ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
<div id="csvDownloadModal" class="modal" th:data-song-id="${songId}">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">CSV ë‹¤ìš´ë¡œë“œ ì„¤ì •</span>
            <span class="modal-close" onclick="closeCsvDownloadModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="csvDownloadForm" class="modal-form">
                <div class="form-row">
                    <label class="form-label">ì‹œì‘ì¼</label>
                    <input type="date" id="csvStartDate" class="form-control" th:value="${startDate}" />
                    <small class="text-muted">ë¹ˆê°’ìœ¼ë¡œ ë‘ë©´ ì „ì²´ ê¸°ê°„ë¶€í„° ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤</small>
                </div>
                <div class="form-row">
                    <label class="form-label">ì¢…ë£Œì¼</label>
                    <input type="date" id="csvEndDate" class="form-control" th:value="${endDate}" />
                    <small class="text-muted">ë¹ˆê°’ìœ¼ë¡œ ë‘ë©´ ì „ì²´ ê¸°ê°„ê¹Œì§€ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCsvDownloadModal()">ì·¨ì†Œ</button>
            <button type="button" class="btn btn-primary" onclick="downloadCsv()">ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>
</div>

<script>
function openCsvDownloadModal() {
    // í˜„ì¬ í•„í„° ê°’ìœ¼ë¡œ ëª¨ë‹¬ ì´ˆê¸°í™”
    document.getElementById('csvStartDate').value = document.querySelector('input[name="startDate"]').value || '';
    document.getElementById('csvEndDate').value = document.querySelector('input[name="endDate"]').value || '';
    
    document.getElementById('csvDownloadModal').classList.add('show');
}

function closeCsvDownloadModal() {
    document.getElementById('csvDownloadModal').classList.remove('show');
}

function downloadCsv() {
    const startDate = document.getElementById('csvStartDate').value;
    const endDate = document.getElementById('csvEndDate').value;
    
    // ëª¨ë‹¬ì—ì„œ songId ê°€ì ¸ì˜¤ê¸°
    const modal = document.getElementById('csvDownloadModal');
    const songId = modal.getAttribute('data-song-id');
    
    if (!songId) {
        alert('ìŒì› IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // URL ìƒì„±
    let url = `/crawling/data/${songId}/csv`;
    const params = new URLSearchParams();
    
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }

    // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
    window.location.href = url;
    
    // ëª¨ë‹¬ ë‹«ê¸°
    closeCsvDownloadModal();
}
</script>

</body>
</html> 