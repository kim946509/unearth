<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>UNEARTH | 크롤링 데이터</title>
    <link rel="icon" type="image/png" href="/img/unearth_icon.png">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/right_holder.css">
</head>
<body>
<div th:replace="~{common/header :: header}"></div>
<div class="main-container">
    <section class="content">
        <div class="page-header">
            <h2 th:text="${songInfo.artistKo} + ' - ' + ${songInfo.titleKo}">크롤링 데이터</h2>
            <a th:href="@{'/right-holder/' + ${rightHolderId}}" class="back-btn">← 노래 목록으로 돌아가기</a>
        </div>

        <!-- 필터링 폼 -->
        <form class="filter-form" method="get" th:action="@{'/crawling/data/' + ${songId}}">
            <div class="filter-row">
                <div class="filter-group">
                    <label>시작일</label>
                    <input type="date" name="startDate" class="filter-input" th:value="${startDate}" />
                </div>
                <div class="filter-group">
                    <label>종료일</label>
                    <input type="date" name="endDate" class="filter-input" th:value="${endDate}" />
                </div>
                <div class="filter-group">
                    <label>플랫폼</label>
                    <select name="platform" class="filter-input">
                        <option value="">전체</option>
                        <option value="MELON" th:selected="${platform == 'MELON'}">멜론</option>
                        <option value="YOUTUBE_MUSIC" th:selected="${platform == 'YOUTUBE_MUSIC'}">유튜브 뮤직</option>
                        <option value="YOUTUBE" th:selected="${platform == 'YOUTUBE'}">유튜브</option>
                        <option value="GENIE" th:selected="${platform == 'GENIE'}">지니</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>페이지 크기</label>
                    <select name="size" class="filter-input">
                        <option value="10" th:selected="${pageSize == 10}">10개</option>
                        <option value="30" th:selected="${pageSize == 20}">30개</option>
                        <option value="50" th:selected="${pageSize == 50}">50개</option>
                        <option value="50" th:selected="${pageSize == 100}">100개</option>
                    </select>
                </div>
                <div class="filter-group filter-btn-group">
                    <button type="submit" class="filter-btn">조회</button>
                </div>
            </div>
        </form>

        <!-- 안내문구 영역 제거 및 팝업 처리 -->
        <div th:if="${response.code != T(com.rhoonart.unearth.common.ResponseCode).SUCCESS and response.message != null and !#strings.isEmpty(response.message)}">
            <script th:inline="javascript">
                alert(/*[[${response.message}]]*/ '오류가 발생했습니다.');
            </script>
        </div>

        <div th:if="${response.data.size() == 0}" class="no-data-message">
            <p>크롤링 데이터가 없습니다.</p>
        </div>

        <div th:if="${response.data.size() > 0}" class="crawling-data-container">
            <table class="crawling-table">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th>플랫폼</th>
                    <th>조회수</th>
                    <th>조회수 증가</th>
                    <th>청취자 수</th>
                    <th>청취자 수 증가</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="data : ${response.data}">
                    <td th:text="${#temporals.format(data.date, 'yyyy-MM-dd')}"></td>
                    <td th:text="${data.platform}"></td>
                    <td th:text="${data.views == -1 ? '-' : (data.views == -999 ? '⚠️' : #numbers.formatInteger(data.views, 0, 'COMMA'))}" 
                        th:class="${data.views == -1 ? 'text-muted' : (data.views == -999 ? 'text-warning' : '')}"></td>
                    <td th:text="${data.viewsIncrease == -1 ? '-' : (data.viewsIncrease == -999 ? '⚠️' : (data.viewsIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.viewsIncrease, 0, 'COMMA'))}"
                        th:class="${data.viewsIncrease == -1 ? 'text-muted' : (data.viewsIncrease == -999 ? 'text-warning' : (data.viewsIncrease > 0 ? 'text-success' : (data.viewsIncrease < 0 ? 'text-danger' : 'text-muted')))}"></td>
                    <td th:text="${data.listeners == -1 ? '-' : (data.listeners == -999 ? '⚠️' : #numbers.formatInteger(data.listeners, 0, 'COMMA'))}"
                        th:class="${data.listeners == -1 ? 'text-muted' : (data.listeners == -999 ? 'text-warning' : '')}"></td>
                    <td th:text="${data.listenersIncrease == -1 ? '-' : (data.listenersIncrease == -999 ? '⚠️' : (data.listenersIncrease > 0 ? '+' : '') + #numbers.formatInteger(data.listenersIncrease, 0, 'COMMA'))}"
                        th:class="${data.listenersIncrease == -1 ? 'text-muted' : (data.listenersIncrease == -999 ? 'text-warning' : (data.listenersIncrease > 0 ? 'text-success' : (data.listenersIncrease < 0 ? 'text-danger' : 'text-muted')))}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- 페이징 -->
        <div th:if="${totalPages > 1}" class="pagination">
            <!-- 이전 페이지 -->
            <a th:if="${currentPage > 1}" 
               th:href="@{'/crawling/data/' + ${songId} + '?page=' + ${currentPage - 1} + '&size=' + ${pageSize} + '&startDate=' + ${startDate} + '&endDate=' + ${endDate} + '&platform=' + ${platform}}" 
               class="page-btn">이전</a>
            
            <!-- 페이지 번호들 -->
            <span th:each="pageNum : ${#numbers.sequence(1, totalPages)}">
                <a th:if="${pageNum != currentPage}" 
                   th:href="@{'/crawling/data/' + ${songId} + '?page=' + ${pageNum} + '&size=' + ${pageSize} + '&startDate=' + ${startDate} + '&endDate=' + ${endDate} + '&platform=' + ${platform}}" 
                   class="page-btn" th:text="${pageNum}"></a>
                <span th:if="${pageNum == currentPage}" class="page-btn current" th:text="${pageNum}"></span>
            </span>
            
            <!-- 다음 페이지 -->
            <a th:if="${currentPage < totalPages}" 
               th:href="@{'/crawling/data/' + ${songId} + '?page=' + ${currentPage + 1} + '&size=' + ${pageSize} + '&startDate=' + ${startDate} + '&endDate=' + ${endDate} + '&platform=' + ${platform}}" 
               class="page-btn">다음</a>
        </div>

        <!-- 결과 정보 -->
        <div th:if="${totalElements > 0}" class="result-info">
            <p>총 <span th:text="${totalElements}">0</span>개의 데이터 중 <span th:text="${(currentPage - 1) * pageSize + 1}">1</span>-<span th:text="${currentPage * pageSize > totalElements ? totalElements : currentPage * pageSize}">20</span>번째 데이터를 표시합니다.</p>
        </div>
    </section>
</div>
</body>
</html> 